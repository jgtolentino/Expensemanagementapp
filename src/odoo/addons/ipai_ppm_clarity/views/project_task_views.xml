<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extended Task Tree View with Clarity Fields -->
    <record id="ipai_project_task_view_tree_clarity" model="ir.ui.view">
        <field name="name">project.task.view.tree.clarity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_tree2"/>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-danger">is_critical == True</attribute>
            </xpath>
            <xpath expr="//field[@name='name']" position="before">
                <field name="wbs_code" optional="show"/>
                <field name="task_type" optional="hide"/>
            </xpath>
            <xpath expr="//field[@name='date_deadline']" position="after">
                <field name="duration_days" optional="show"/>
                <field name="percent_complete" widget="progressbar" optional="show"/>
                <field name="is_critical" widget="boolean_toggle" optional="show"/>
                <field name="locked" widget="boolean_toggle" optional="hide"/>
                <field name="float_days" optional="hide"/>
                <field name="phase_id" optional="show"/>
            </xpath>
        </field>
    </record>

    <!-- Extended Task Form View with Clarity Fields -->
    <record id="ipai_project_task_view_form_clarity" model="ir.ui.view">
        <field name="name">project.task.view.form.clarity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_form2"/>
        <field name="priority">100</field>
        <field name="arch" type="xml">
            <!-- Add Clarity buttons to header -->
            <xpath expr="//header" position="inside">
                <button name="action_lock" string="Lock" type="object" icon="fa-lock" invisible="locked == True" groups="ipai_ppm_clarity.group_clarity_scheduler"/>
                <button name="action_unlock" string="Unlock" type="object" icon="fa-unlock" invisible="locked == False" groups="ipai_ppm_clarity.group_clarity_scheduler"/>
            </xpath>

            <!-- Add stat buttons -->
            <xpath expr="//div[@name='button_box']" position="inside">
                <button class="oe_stat_button" name="action_view_predecessors" type="object" icon="fa-arrow-left" invisible="predecessor_count == 0">
                    <field name="predecessor_count" widget="statinfo" string="Predecessors"/>
                </button>
                <button class="oe_stat_button" name="action_view_successors" type="object" icon="fa-arrow-right" invisible="successor_count == 0">
                    <field name="successor_count" widget="statinfo" string="Successors"/>
                </button>
                <button class="oe_stat_button" name="action_view_todos" type="object" icon="fa-check-square-o">
                    <div class="o_field_widget o_stat_info">
                        <span class="o_stat_value">
                            <field name="todo_done_count"/>/<field name="todo_count"/>
                        </span>
                        <span class="o_stat_text">To-Dos</span>
                    </div>
                </button>
            </xpath>

            <!-- Add Clarity fields after basic info -->
            <xpath expr="//group[@name='project_info']" position="after">
                <group name="clarity_info" string="Clarity Settings">
                    <group>
                        <field name="task_type"/>
                        <field name="phase_id" domain="[('project_id', '=', project_id)]"/>
                        <field name="wbs_code"/>
                        <field name="wbs_level" readonly="1"/>
                    </group>
                    <group>
                        <field name="duration_days"/>
                        <field name="percent_complete" widget="progressbar"/>
                        <field name="locked" widget="boolean_toggle"/>
                        <field name="is_subproject"/>
                    </group>
                </group>
            </xpath>

            <!-- Add CPM/Schedule tab -->
            <xpath expr="//notebook" position="inside">
                <page string="Schedule (CPM)" name="cpm_schedule" groups="ipai_ppm_clarity.group_clarity_scheduler">
                    <group>
                        <group string="Early Dates">
                            <field name="early_start"/>
                            <field name="early_finish"/>
                        </group>
                        <group string="Late Dates">
                            <field name="late_start"/>
                            <field name="late_finish"/>
                        </group>
                    </group>
                    <group>
                        <group string="Float &amp; Critical Path">
                            <field name="float_days"/>
                            <field name="is_critical" widget="boolean_toggle"/>
                        </group>
                        <group string="Constraints">
                            <field name="constraint_type"/>
                            <field name="constraint_date"/>
                        </group>
                    </group>
                    <group string="Tentative Schedule" invisible="tentative_active == False">
                        <group>
                            <field name="tentative_start"/>
                            <field name="tentative_finish"/>
                            <field name="tentative_active"/>
                        </group>
                        <group>
                            <button name="publish_tentative_schedule" string="Publish Schedule" type="object" class="btn-primary"/>
                            <button name="discard_tentative_schedule" string="Discard" type="object" class="btn-secondary"/>
                        </group>
                    </group>
                </page>

                <page string="Dependencies" name="dependencies">
                    <group>
                        <group string="Predecessors">
                            <field name="predecessor_ids" nolabel="1">
                                <tree editable="bottom">
                                    <field name="predecessor_id" domain="[('project_id', '=', parent.project_id), ('id', '!=', parent.id)]"/>
                                    <field name="dependency_type"/>
                                    <field name="lag_days"/>
                                </tree>
                            </field>
                        </group>
                        <group string="Successors">
                            <field name="successor_ids" nolabel="1" readonly="1">
                                <tree>
                                    <field name="successor_id"/>
                                    <field name="dependency_type"/>
                                    <field name="lag_days"/>
                                </tree>
                            </field>
                        </group>
                    </group>
                </page>

                <page string="To-Dos" name="todos">
                    <field name="todo_ids">
                        <tree editable="bottom">
                            <field name="sequence" widget="handle"/>
                            <field name="name"/>
                            <field name="due_date"/>
                            <field name="owner_id" widget="many2one_avatar_user"/>
                            <field name="priority"/>
                            <field name="state" widget="badge"/>
                            <button name="action_done" string="Done" type="object" icon="fa-check" invisible="state == 'done'"/>
                            <button name="action_reopen" string="Reopen" type="object" icon="fa-undo" invisible="state == 'open'"/>
                        </tree>
                    </field>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Clarity WBS Grid View -->
    <record id="ipai_project_task_view_tree_wbs" model="ir.ui.view">
        <field name="name">project.task.view.tree.wbs</field>
        <field name="model">project.task</field>
        <field name="arch" type="xml">
            <tree string="WBS Tasks" decoration-danger="is_critical == True" decoration-info="is_milestone == True" decoration-bf="is_summary == True" default_order="wbs_sort">
                <field name="wbs_code"/>
                <field name="name"/>
                <field name="task_type" widget="badge"/>
                <field name="phase_id"/>
                <field name="planned_date_begin"/>
                <field name="date_deadline"/>
                <field name="duration_days"/>
                <field name="percent_complete" widget="progressbar"/>
                <field name="user_ids" widget="many2many_avatar_user"/>
                <field name="predecessor_count"/>
                <field name="is_critical" widget="boolean_toggle"/>
                <field name="locked" widget="boolean_toggle"/>
                <field name="float_days"/>
                <field name="wbs_sort" column_invisible="True"/>
            </tree>
        </field>
    </record>

    <!-- Search View Extension -->
    <record id="ipai_project_task_view_search_clarity" model="ir.ui.view">
        <field name="name">project.task.view.search.clarity</field>
        <field name="model">project.task</field>
        <field name="inherit_id" ref="project.view_task_search_form"/>
        <field name="arch" type="xml">
            <xpath expr="//search" position="inside">
                <filter string="Critical Path" name="critical" domain="[('is_critical', '=', True)]"/>
                <filter string="Milestones" name="milestones" domain="[('is_milestone', '=', True)]"/>
                <filter string="Locked" name="locked" domain="[('locked', '=', True)]"/>
                <filter string="Has Tentative" name="tentative" domain="[('tentative_active', '=', True)]"/>
                <separator/>
                <filter string="Phase" name="group_phase" context="{'group_by': 'phase_id'}"/>
                <filter string="Task Type" name="group_type" context="{'group_by': 'task_type'}"/>
            </xpath>
        </field>
    </record>

    <!-- WBS Tasks Action -->
    <record id="ipai_project_task_wbs_action" model="ir.actions.act_window">
        <field name="name">WBS Tasks</field>
        <field name="res_model">project.task</field>
        <field name="view_mode">tree,form,kanban</field>
        <field name="view_id" ref="ipai_project_task_view_tree_wbs"/>
        <field name="domain">[('project_id', '!=', False)]</field>
        <field name="context">{'default_project_id': active_id}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create tasks in the Work Breakdown Structure
            </p>
        </field>
    </record>
</odoo>
